<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="owc-core-authentication-manager">
  <template>
  </template>

  <script>
    /**
     * `owc-core-authentication-manager`
     * `authentication-manager` component is devoted to inject user credential in each http request performed within OWC application.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class OwcCoreAuthenticationManager extends Polymer.Element {

      static get is() {
        return 'owc-core-authentication-manager';
      }

      static get properties() {
        return {
          _ctx: {
            type: Object,
            value: {}
          },

          logged: { //property to handle logged status
            type: Boolean,
            value: false
          }
        };
      }

      //Method called when this element is created
      constructor() {
        super();
      }

      /**
      *   This method verify user's status(loggedIn or loggedOut)
      *
      * @return {boolean} true if user credential are stored (logged-in user), false otherwise
      */
      isLogged() {
        var self = this;
        return self.logged;
      }

      testConnection() {
        var self = this;
        var result = self.logged;
        return result;
      }

      /**
      * This method is used to allow users to perform authentication on the service.
      * If inserted credentials  are valid, they are stored on session and the request is forwarded to server.
      * If inserted credential are not valid, an error message is shown to notify user about authentication failure
      *
      * @param {string} username: user's username
      * @param {string} password: user's password
      * @return {Object} Login request outcome as JavaScript Promise
      */
      login(username, password) {
        var self = this;

        //1) Encapsulate username and password in an object
        var credentials = {
          "login_username": username,
          "login_password": password
        }

        //2) Construct params from credentials
        var params = Object.keys(credentials).map(function (k) {
          return encodeURIComponent(k) + '=' + encodeURIComponent(credentials[k])
        }).join('&')

        /*3) Prepare request, setting:
        *     - method  : ("GET", "POST", ...)
        *     - loginURL: url + mapping
        *     - options : headers, body (with params)
        */
        var method = "POST";
        var loginURL = 'https://scihub.copernicus.eu/dhus/' + 'login';
        var options = {
          headers: [{
            name: "Content-Type",
            value: "application/x-www-form-urlencoded"
          }, {
            name: "Authorization",
            value: "Basic " + window.btoa(username + ':' + password)
          }],
          body: params
        }

        //HTTP REQUEST USING HTTP MANAGER
        var promise = self._ctx.httpm.sendRequest(method, loginURL, options);

        //Handle Promise Result
        promise.then(

          //OK
          function (result) {
            self.logged = true;
            //TODO: Set owc-core-login-box isLogged property to true;
            return true;
          },

          //ERROR
          function (err) {
            //TODO: Set owc-core-login-box isLogged property to false;
            self.logged = false;
            return false;
          });
      }

      //LOGOUT function. Set logged variable to false and return true to indicate that logout was successful
      // This method is used to allow users to perform logout.
      logout() {
        var self = this;
        self.logged = false;
        return true; //True means that the user properly logged out
      }
    }
    window.customElements.define(OwcCoreAuthenticationManager.is, OwcCoreAuthenticationManager);
  </script>
</dom-module>